# vim:set ft=dockerfile:
FROM ubuntu:22.04 AS builder

ENV DEBIAN_FRONTEND=noninteractive

ARG BUILD_SYSTEM="autotools"

RUN apt-get update -qq && \
    apt-get install -y gcc g++ make autoconf automake libtool cmake ninja-build \
       libfcgi-dev libxml2-dev libmemcached-dev \
       libboost-program-options-dev libcrypto++-dev libyajl-dev \
       libpqxx-dev zlib1g-dev libargon2-dev libfmt-dev \
       postgresql-14 postgresql-server-dev-all \
       --no-install-recommends && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy the main application.
COPY . ./

# Compile, install and remove source
RUN if [ "$BUILD_SYSTEM" = "cmake" ]; then \
        mkdir build && cd build && \
        CXXFLAGS="-Wall -Wextra -Wpedantic -Wno-unused-parameter" CMAKE_MAKE_PROGRAM=ninja cmake .. -DBUILD_SHARED_LIBS=OFF -DBUILD_TESTING=ON -G Ninja && \
        cmake --build . && \
        cmake --build . -t test && \
        strip openstreetmap-cgimap && \
        cp openstreetmap-cgimap ../ ; \
    elif [ "$BUILD_SYSTEM" = "autotools" ]; then \
        ./autogen.sh && \
        ./configure --enable-static --disable-shared --enable-yajl CXXFLAGS="-Wall -Wextra -Wpedantic -Wno-unused-parameter" && \
        make -j${nproc} check TESTS= && \
        make check || ( cat ./test-suite.log ; exit 1 ) && \
        strip openstreetmap-cgimap; \
    else \
        echo "Unknown build system ${BUILD_SYSTEM}" && exit 1; \
    fi

FROM ubuntu:22.04

RUN apt-get update -qq && \
    apt-get install -y \
       libfcgi-bin libmemcached11 libboost-program-options1.74.0 \
       libxml2 libcrypto++8 libyajl2 libpqxx-6.4 zlib1g libargon2-1 argon2 libfmt8 \
       --no-install-recommends && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

COPY --from=builder /app/openstreetmap-cgimap /usr/local/bin

RUN groupadd -g 61000 cgimap && \
    useradd -g 61000 -l -M -s /bin/false -u 61000 cgimap

USER cgimap

ENV CGIMAP_HOST db
ENV CGIMAP_DBNAME openstreetmap
ENV CGIMAP_USERNAME openstreetmap
ENV CGIMAP_PASSWORD openstreetmap
ENV CGIMAP_MEMCACHE memcached
ENV CGIMAP_RATELIMIT 204800
ENV CGIMAP_MAXDEBT 250
ENV CGIMAP_MODERATOR_RATELIMIT 1048576
ENV CGIMAP_MODERATOR_MAXDEBT 1024
ENV CGIMAP_PORT 8000
ENV CGIMAP_INSTANCES 10

EXPOSE 8000

ENTRYPOINT /usr/local/bin/openstreetmap-cgimap --pidfile /tmp/cgimap.pid --logfile=/proc/1/fd/1 --daemon && \
           tail --pid=$(cat /tmp/cgimap.pid) -f /dev/null

